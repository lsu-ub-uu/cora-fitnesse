---
Suite
---
!***> Set up system and log in
| import |
| se.uu.ub.cora.fitnesseintegration |
| se.uu.ub.cora.fitnesseintegration.apptoken.script |
| se.uu.ub.cora.fitnesseintegration.authtoken.fixture |
| se.uu.ub.cora.fitnesseintegration.file |
| se.uu.ub.cora.fitnesseintegration.fixture |
| se.uu.ub.cora.fitnesseintegration.compare |
| se.uu.ub.cora.fitnesseintegration.script |
| se.uu.ub.cora.fitnesseintegration.waiter.fixture |
| se.uu.ub.cora.fitnesseintegration.server.compare.fixtures |
| se.uu.ub.cora.fitnesseintegration.binary |
| se.uu.ub.cora.fitnesseintegration.definitionwriter |
| se.uu.ub.cora.fitnesseintegration.authentication |

!| script | LoginToken |
| setFitnesseAdminLoginId | ${fitnesseAdminLoginId} |
| setFitnesseUserLoginId | ${fitnesseUserLoginId} |

!| script | SystemUrl |
| setUrl | ${systemUnderTestUrl} |
| setAppTokenVerifierUrl | ${appTokenVerifierUrl} |
| setIdpLoginUrl | ${idpLoginUrl} |
| setGatekeeperServerUrl | ${gatekeeperServerUrl} |

!| script | DependencyProvider |
| setHttpHandlerFactoryClassName | se.uu.ub.cora.httphandler.HttpHandlerFactoryImp |
| setChildComparerUsingClassName | se.uu.ub.cora.fitnesseintegration.ChildComparerImp |

!define TEST_SYSTEM {slim}

!***> Login for fitnesse admin, user and guest
!| AuthenticationFixture |
|  EPPN                           | idpLogin? | getStatusType? |getAuthToken?     | getRenewUrl?    |
| fitnesseAdmin@system.cora.uu.se |           | OK             | $adminAuthToken= | $adminRenewUrl= |
| fitnesseUser@system.cora.uu.se  |           | OK             | $userAuthToken=  | $userRenewUrl=  |
| userNotInDb@user.uu.se          |           | OK             | $guestAuthToken= | $guestRenewUrl= |

!| script | AuthTokenHolder |
| setAdminAuthToken | $adminAuthToken |
| setUserAuthToken  | $userAuthToken  |

#Ta bort när vi har fixat ett sätt att skapa appTokens från ett befintlig användare. Vi vill kunna läsa nuvarande användare och få ett apptoken från den. Att använda rest anropet löser inte riktigt våran problem.
!| script | LoginToken |
| setFitnesseAdminAppToken | ${fitnesseAdminAppToken} |
| setFitnesseUserAppToken | ${fitnesseUserAppToken} |


#!| Table:smartrics.rest.fitnesse.fixture.RestFixture | ${systemUnderTestUrl}rest/ |
#| setHeader | Accept:application/vnd.cora.record+json!-
#-!Content-Type:application/vnd.cora.recordgroup+json!-
#-!authToken:$adminAuthToken |
#| setBody | {"name":"user","children":[{"name":"recordInfo","children":[{"name":"ignoreOverwriteProtection","value":"true"},{"name":"id","value":"131313"},{"name":"type","children":[{"name":"linkedRecordType","value":"recordType"},{"name":"linkedRecordId","value":"user"}]},{"name":"validationType","children":[{"name":"linkedRecordType","value":"validationType"},{"name":"linkedRecordId","value":"systemOneUser"}]},{"name":"dataDivider","children":[{"name":"linkedRecordType","value":"system"},{"name":"linkedRecordId","value":"cora"}]}]},{"name":"loginId","value":"fitnesseAdmin@system.cora.uu.se"},{"name":"userFirstname","value":"Fitnesse"},{"name":"userLastname","value":"Admin"},{"name":"userRole","repeatId":"1","children":[{"name":"userRole","children":[{"name":"linkedRecordType","value":"permissionRole"},{"name":"linkedRecordId","value":"everything"}]},{"name":"permissionTermRulePart","repeatId":"0","children":[{"name":"rule","children":[{"name":"linkedRecordType","value":"collectTerm"},{"name":"linkedRecordId","value":"systemPermissionTerm"}]},{"name":"value","repeatId":"0","value":"system.*"}]}]},{"name":"userRole","repeatId":"3603423986673","children":[{"name":"userRole","children":[{"name":"linkedRecordType","value":"permissionRole"},{"name":"linkedRecordId","value":"binaryUserRole"}]}]},{"name":"activeStatus","value":"active"},{"name":"appTokens","children":[{"name":"appToken","repeatId":"0","children":[{"name":"appTokenLink","children":[{"name":"linkedRecordType","value":"systemSecret"},{"name":"linkedRecordId","value":"systemSecret:3452556002950361"}]},{"name":"appTokenNote","value":"Token for development"}]},{"name":"appToken","repeatId":"1","children":[{"name":"appTokenNote","value":"My admin device"}]}]},{"name":"usePassword","value":"false"}],"attributes":{"type":"systemOneUser"}} |
#| POST | /record/user/131313 | 200 | | |
#| let | adminAppToken | js | response.body.match(/"appTokenClearText","value":"([^"]+)"}/)[1] | $adminAppToken= |
#
#!| script | LoginToken |
#| setFitnesseAdminAppToken | $adminAppToken |
*!
*!
