!2 Update
There are a few different cases for update that can happen, when there are write restrictions:

 * '''Case 1''': A user (fitnesseAdmin) has write permission on all restricted data, update all restricted record parts
 * A user (fitnesseUser) has write permission on some but not all restricted data, there are 3 subcases
   * '''Case 2''': A user only sends the record parts that it has write permissions for. Update the sent parts leaving the unsent parts, that the user does not have write access for, unchanged.
   * '''Case 3''': A user only sends the record parts that it has write permissions for and one of the record parts not sent is mandatory. Update the sent parts leaving the unsent parts, that the user does not have write access for, unchanged. No validation error should be thrown.
   * '''Case 4''': A user sends both record parts that it does NOT have write permissions for and part that it does. Update the sent parts that the user has permissions for, leaving the parts that the user does not have write permissions for unchanged.
   * '''Case 5''': A user does not send a mandatory record part that it has write permissions for. The update should fail with a validation error, as we are missing mandatory data in the update.
   * '''Case 6''': A user should have a list with write and read permissions. All write permissions implies read permissions. Permissions has to be equal to fitnesseUser permissions.

!***> Case 1

!define currentAuthToken {$adminAuthToken}
!-Create a new testWorkout record as fitnesseAdmin, adding unrestricted and all restricted data parts-!

!include -seamless .TheRestTests.CallThroughJavaCode.BuiltInMetadataFunctionality.RecordPart.dataCirkelfysCirkelfys1
!define expectedUpdateResult {OK}
!define expectedAnswer {}
!define expectedCompareResult {OK}
!define expectedActionResult {Action read_incoming_links is missing.}
!define expectedPermissionResult {OK}
!include -seamless .HelperPages.updateCheckReadCheck

*!
!***> Case 2

*******************************
!define currentAuthToken {$userAuthToken}

!-Create a new testWorkout record as fitnesseAdmin, adding unrestricted and all restricted data parts-!

!include -seamless .TheRestTests.CallThroughJavaCode.BuiltInMetadataFunctionality.RecordPart.dataCirkelfysCirkelfys1
!include -seamless .TheRestTests.CallThroughJavaCode.BuiltInMetadataFunctionality.RecordPart.dataCirkelfysCirkelfys1Minimal
!define expectedUpdateResult {OK}
!define expectedAnswer {}
!define expectedCompareResult {OK}
!define expectedActionResult {Action delete is missing. Action index is missing. Action read_incoming_links is missing.}
!define expectedPermissionResult {Read permission instructorId3 is missing. Read permission duration1_3 is missing. Read permission lastName1_3 is missing. Read permission lastName2_3 is missing. Read permission voteCount1_3 is missing. Read permission voteCount2_3 is missing. Read permission popularity3 is missing. Read permission voteCount3_1 is missing. Read permission voteCount3_2 is missing. Read permission voteCount3_3 is missing. Write permission numOfParticipants2 is missing. Write permission instructorId2 is missing. Write permission instructorId3 is missing. Write permission laps1_2 is missing. Write permission duration1_2 is missing. Write permission duration1_3 is missing. Write permission firstName1_2 is missing. Write permission lastName1_2 is missing. Write permission lastName1_3 is missing. Write permission instructorName2 is missing. Write permission firstName2_1 is missing. Write permission firstName2_2 is missing. Write permission lastName2_1 is missing. Write permission lastName2_2 is missing. Write permission lastName2_3 is missing. Write permission ratingDate1_2 is missing. Write permission voteCount1_2 is missing. Write permission voteCount1_3 is missing. Write permission popularity2 is missing. Write permission ratingDate2_1 is missing. Write permission ratingDate2_2 is missing. Write permission voteCount2_1 is missing. Write permission voteCount2_2 is missing. Write permission voteCount2_3 is missing. Write permission popularity3 is missing. Write permission ratingDate3_1 is missing. Write permission ratingDate3_2 is missing. Write permission voteCount3_1 is missing. Write permission voteCount3_2 is missing. Write permission voteCount3_3 is missing.}
!include -seamless .HelperPages.updateCheckReadCheck







*******************************

!| ChildComparerFixture |
| authToken | type | id | children | testReadAndStoreRecord? | testCheckContainWithValues? |
| $adminAuthToken | testWorkout | cirkelfys1 | {"children":[{"type":"atomic","name":"workoutName","value":"cirkelfys"},{"type":"atomic","name":"instructorId","value":"6666"},{"type":"atomic","name":"numOfParticipants","value":"30"},{"type":"group","name":"instructorName","children":[{"type":"atomic","name":"firstName","value":"Emma"},{"type":"atomic","name":"lastName","value":"Kula"}]},{"type":"group","name":"popularity","children":[{"type":"atomic","name":"rating","value":"8"}]},{"type":"atomic","name":"city","value":"Uppsala"},{"type":"atomic","name":"country","value":"Sweden"}]} | | OK |

Try to change noOfParticipants=25, workoutName=cyckel

!| ChildComparerFixture |
| authToken | type | id | json | testUpdateAndStoreRecord? | getStatusType? |
| $userAuthToken | testWorkout | cirkelfys1 | {"name":"workout","children":[{"name":"recordInfo","children":[{"name":"id","value":"cirkelfys1"},{"name":"type","children":[{"name":"linkedRecordType","value":"recordType"},{"name":"linkedRecordId","value":"testWorkout"}]},{"name":"createdBy","children":[{"name":"linkedRecordType","value":"user"},{"name":"linkedRecordId","value":"141414"}]},{"name":"dataDivider","children":[{"name":"linkedRecordType","value":"system"},{"name":"linkedRecordId","value":"systemOne"}]},{"name":"tsCreated","value":"2018-08-29T14:27:20.307000Z"},{"name":"updated","children":[{"name":"updatedBy","children":[{"name":"linkedRecordType","value":"user"},{"name":"linkedRecordId","value":"141414"}]},{"name":"tsUpdated","value":"2018-08-29T14:27:20.307000Z"}],"repeatId":"1"}]},{"name":"workoutName","value":"cyckel"},{"name":"numOfParticipants","value":"25"}]} | | OK |

Validate the '''response''' returned on the update call contains the expected record parts.

!| ChildComparerFixture |
| children | testCheckContainWithValues? |
| {"children":[{"type":"atomic","name":"workoutName","value":"cyckel"},{"type":"atomic","name":"instructorId","value":"6666"},{"type":"atomic","name":"numOfParticipants","value":"25"},{"type":"group","name":"instructorName","children":[{"type":"atomic","name":"firstName","value":"Emma"},{"type":"atomic","name":"lastName","value":"Kula"}]},{"type":"atomic","name":"city","value":"Uppsala"},{"type":"atomic","name":"country","value":"Sweden"}]} | OK |

Validate the '''response''' returned on the update call does not contain popularity record part.

!| ChildComparerFixture |
| children | testCheckContain? |
| {"children":[{"name":"popularity"}]} | Child with nameInData popularity is missing. |

Validate by reading the stored record again. Make sure all data parts are in the updated record. Validate that noOfParticipants=25 and workoutName=cyckel, and others are not changed

!| ChildComparerFixture |
| authToken | type | id | children | testReadAndStoreRecord? | testCheckContainWithValues? |
| $adminAuthToken | testWorkout | cirkelfys1 | {"children":[{"type":"atomic","name":"workoutName","value":"cyckel"},{"type":"atomic","name":"instructorId","value":"6666"},{"type":"atomic","name":"numOfParticipants","value":"25"},{"type":"group","name":"instructorName","children":[{"type":"atomic","name":"firstName","value":"Emma"},{"type":"atomic","name":"lastName","value":"Kula"}]},{"type":"group","name":"popularity","children":[{"type":"atomic","name":"rating","value":"8"}]},{"type":"atomic","name":"city","value":"Uppsala"},{"type":"atomic","name":"country","value":"Sweden"}]} | | OK |

*!
!***> Case 3

!| ChildComparerFixture |
| authToken | type | id | children | testReadAndStoreRecord? | testCheckContainWithValues? |
| $adminAuthToken | testWorkout | cirkelfys1 | {"children":[{"type":"atomic","name":"workoutName","value":"cyckel"},{"type":"atomic","name":"instructorId","value":"6666"},{"type":"atomic","name":"numOfParticipants","value":"25"},{"type":"group","name":"instructorName","children":[{"type":"atomic","name":"firstName","value":"Emma"},{"type":"atomic","name":"lastName","value":"Kula"}]},{"type":"group","name":"popularity","children":[{"type":"atomic","name":"rating","value":"8"}]},{"type":"atomic","name":"city","value":"Uppsala"},{"type":"atomic","name":"country","value":"Sweden"}]} | | OK |

!include -seamless <RecordPart.RecordPartRemoveWritePermissionOnNumOfParticipants
Try to update workoutName=atom, and others are not changed

!| ChildComparerFixture |
| authToken | type | id | json | testUpdateAndStoreRecord? | getStatusType? |
| $userAuthToken | testWorkout | cirkelfys1 | {"name":"workout","children":[{"name":"recordInfo","children":[{"name":"id","value":"cirkelfys1"},{"name":"type","children":[{"name":"linkedRecordType","value":"recordType"},{"name":"linkedRecordId","value":"testWorkout"}]},{"name":"createdBy","children":[{"name":"linkedRecordType","value":"user"},{"name":"linkedRecordId","value":"141414"}]},{"name":"dataDivider","children":[{"name":"linkedRecordType","value":"system"},{"name":"linkedRecordId","value":"systemOne"}]},{"name":"tsCreated","value":"2018-08-29T14:27:20.307000Z"},{"name":"updated","children":[{"name":"updatedBy","children":[{"name":"linkedRecordType","value":"user"},{"name":"linkedRecordId","value":"141414"}]},{"name":"tsUpdated","value":"2018-08-29T14:27:20.307000Z"}],"repeatId":"1"}]},{"name":"workoutName","value":"atom"},{"name":"instructorName","children":[{"name":"firstName","value":"Rut-Emma"},{"name":"lastName","value":"Projektledare"}]},{"name":"popularity","children":[{"name":"rating","value":"0"}]}]} | | OK |

Validate the '''response''' returned on the update call contains the expected record parts.

!| ChildComparerFixture |
| children | testCheckContainWithValues? |
| {"children":[{"type":"atomic","name":"workoutName","value":"atom"},{"type":"atomic","name":"instructorId","value":"6666"},{"type":"atomic","name":"numOfParticipants","value":"25"},{"type":"group","name":"instructorName","children":[{"type":"atomic","name":"firstName","value":"Emma"},{"type":"atomic","name":"lastName","value":"Kula"}]},{"type":"atomic","name":"city","value":"Uppsala"},{"type":"atomic","name":"country","value":"Sweden"}]} | OK |

Validate the '''response''' returned on the update call does not contain popularity record part.

!| ChildComparerFixture |
| children | testCheckContain? |
| {"children":[{"name":"popularity"}]} | Child with nameInData popularity is missing. |

Validate by reading the stored record again. Make sure all data parts are in the updated record.

!| ChildComparerFixture |
| authToken | type | id | children | testReadAndStoreRecord? | testCheckContainWithValues? |
| $adminAuthToken | testWorkout | cirkelfys1 | {"children":[{"type":"atomic","name":"workoutName","value":"atom"},{"type":"atomic","name":"instructorId","value":"6666"},{"type":"atomic","name":"numOfParticipants","value":"25"},{"type":"group","name":"instructorName","children":[{"type":"atomic","name":"firstName","value":"Emma"},{"type":"atomic","name":"lastName","value":"Kula"}]},{"type":"group","name":"popularity","children":[{"type":"atomic","name":"rating","value":"8"}]},{"type":"atomic","name":"city","value":"Uppsala"},{"type":"atomic","name":"country","value":"Sweden"}]} | | OK |

!include -seamless <RecordPart.RecordPartReturnWritePermissionOnNumOfParticipants
*!
!***> Case 4

*******************************
!define currentAuthToken {$userAuthToken}

!-Create a new testWorkout record as fitnesseAdmin, adding unrestricted and all restricted data parts-!

!include -seamless .TheRestTests.CallThroughJavaCode.BuiltInMetadataFunctionality.RecordPart.dataCirkelfysCirkelfys1
!define expectedUpdateResult {OK}
!define expectedAnswer {}
!define expectedCompareResult {Child with nameInData instructorId3 and type atomic is missing. Child with nameInData duration1_3 and type atomic is missing. Child with nameInData lastName1_3 and type atomic is missing. Child with nameInData firstName2_1 and type atomic is missing. Child with nameInData firstName2_2 and type atomic is missing. Child with nameInData lastName2_1 and type atomic is missing. Child with nameInData lastName2_2 and type atomic is missing. Child with nameInData lastName2_3 and type atomic is missing. Child with nameInData voteCount1_3 and type atomic is missing. Child with nameInData ratingDate2_1 and type atomic is missing. Child with nameInData ratingDate2_2 and type atomic is missing. Child with nameInData voteCount2_1 and type atomic is missing. Child with nameInData voteCount2_2 and type atomic is missing. Child with nameInData voteCount2_3 and type atomic is missing. Child with nameInData popularity3 and type group is missing.}
!define expectedActionResult {Action delete is missing. Action index is missing. Action read_incoming_links is missing.}
!define expectedPermissionResult {Read permission instructorId3 is missing. Read permission duration1_3 is missing. Read permission lastName1_3 is missing. Read permission lastName2_3 is missing. Read permission voteCount1_3 is missing. Read permission voteCount2_3 is missing. Read permission popularity3 is missing. Read permission voteCount3_1 is missing. Read permission voteCount3_2 is missing. Read permission voteCount3_3 is missing. Write permission numOfParticipants2 is missing. Write permission instructorId2 is missing. Write permission instructorId3 is missing. Write permission laps1_2 is missing. Write permission duration1_2 is missing. Write permission duration1_3 is missing. Write permission firstName1_2 is missing. Write permission lastName1_2 is missing. Write permission lastName1_3 is missing. Write permission instructorName2 is missing. Write permission firstName2_1 is missing. Write permission firstName2_2 is missing. Write permission lastName2_1 is missing. Write permission lastName2_2 is missing. Write permission lastName2_3 is missing. Write permission ratingDate1_2 is missing. Write permission voteCount1_2 is missing. Write permission voteCount1_3 is missing. Write permission popularity2 is missing. Write permission ratingDate2_1 is missing. Write permission ratingDate2_2 is missing. Write permission voteCount2_1 is missing. Write permission voteCount2_2 is missing. Write permission voteCount2_3 is missing. Write permission popularity3 is missing. Write permission ratingDate3_1 is missing. Write permission ratingDate3_2 is missing. Write permission voteCount3_1 is missing. Write permission voteCount3_2 is missing. Write permission voteCount3_3 is missing.}
!include -seamless .HelperPages.updateCheckReadCheck

*******************************

!| ChildComparerFixture |
| authToken | type | id | children | testReadAndStoreRecord? | testCheckContainWithValues? |
| $adminAuthToken | testWorkout | cirkelfys1 | {"children":[{"type":"atomic","name":"workoutName","value":"atom"},{"type":"atomic","name":"instructorId","value":"6666"},{"type":"atomic","name":"numOfParticipants","value":"25"},{"type":"group","name":"instructorName","children":[{"type":"atomic","name":"firstName","value":"Emma"},{"type":"atomic","name":"lastName","value":"Kula"}]},{"type":"group","name":"popularity","children":[{"type":"atomic","name":"rating","value":"8"}]},{"type":"atomic","name":"city","value":"Uppsala"},{"type":"atomic","name":"country","value":"Sweden"}]} | | OK |

Try to change noOfParticipants=10, firstName=Rut-Emma, lastName=Projektledare, rating(popularity)=0, instructorId=123456, workoutname=cirkelfys

!| ChildComparerFixture |
| authToken | type | id | json | testUpdateAndStoreRecord? | getStatusType? |
| $userAuthToken | testWorkout | cirkelfys1 | {"name":"workout","children":[{"name":"recordInfo","children":[{"name":"id","value":"cirkelfys1"},{"name":"type","children":[{"name":"linkedRecordType","value":"recordType"},{"name":"linkedRecordId","value":"testWorkout"}]},{"name":"createdBy","children":[{"name":"linkedRecordType","value":"user"},{"name":"linkedRecordId","value":"141414"}]},{"name":"dataDivider","children":[{"name":"linkedRecordType","value":"system"},{"name":"linkedRecordId","value":"systemOne"}]},{"name":"tsCreated","value":"2018-08-29T14:27:20.307000Z"},{"name":"updated","children":[{"name":"updatedBy","children":[{"name":"linkedRecordType","value":"user"},{"name":"linkedRecordId","value":"141414"}]},{"name":"tsUpdated","value":"2018-08-29T14:27:20.307000Z"}],"repeatId":"1"}]},{"name":"workoutName","value":"cirkelfys"},{"name":"numOfParticipants","value":"10"},{"name":"instructorId","value":"123456"},{"name":"instructorName","children":[{"name":"firstName","value":"Rut-Emma"},{"name":"lastName","value":"Projektledare"}]},{"name":"popularity","children":[{"name":"rating","value":"0"}]},{"name":"city","value":"Berlin"},{"name":"country","value":"Germany"}]} | | OK |

Validate the '''response''' returned on the update call contains the expected record parts.

!| ChildComparerFixture |
| children | testCheckContainWithValues? |
| {"children":[{"type":"atomic","name":"workoutName","value":"cirkelfys"},{"type":"atomic","name":"instructorId","value":"6666"},{"type":"atomic","name":"numOfParticipants","value":"10"},{"type":"group","name":"instructorName","children":[{"type":"atomic","name":"firstName","value":"Emma"},{"type":"atomic","name":"lastName","value":"Kula"}]},{"type":"atomic","name":"city","value":"Uppsala"},{"type":"atomic","name":"country","value":"Sweden"}]} | OK |

Validate the '''response''' returned on the update call does not contain popularity record part.

!| ChildComparerFixture |
| children | testCheckContain? |
| {"children":[{"name":"popularity"}]} | Child with nameInData popularity is missing. |

Validate by reading the stored record again. Make sure all data parts are in the updated record. Validate that noOfParticipants is changed to 10 and workoutname=cirkelfys, and other restricted values are not changed.

!| ChildComparerFixture |
| authToken | type | id | children | testReadAndStoreRecord? | testCheckContainWithValues? |
| $adminAuthToken | testWorkout | cirkelfys1 | {"children":[{"type":"atomic","name":"workoutName","value":"cirkelfys"},{"type":"atomic","name":"instructorId","value":"6666"},{"type":"atomic","name":"numOfParticipants","value":"10"},{"type":"group","name":"instructorName","children":[{"type":"atomic","name":"firstName","value":"Emma"},{"type":"atomic","name":"lastName","value":"Kula"}]},{"type":"group","name":"popularity","children":[{"type":"atomic","name":"rating","value":"8"}]},{"type":"atomic","name":"city","value":"Uppsala"},{"type":"atomic","name":"country","value":"Sweden"}]} | | OK |

*!
!***> Case 5

!| ChildComparerFixture |
| authToken | type | id | children | testReadAndStoreRecord? | testCheckContainWithValues? |
| $adminAuthToken | testWorkout | cirkelfys1 | {"children":[{"type":"atomic","name":"workoutName","value":"cirkelfys"},{"type":"atomic","name":"instructorId","value":"6666"},{"type":"atomic","name":"numOfParticipants","value":"10"},{"type":"group","name":"instructorName","children":[{"type":"atomic","name":"firstName","value":"Emma"},{"type":"atomic","name":"lastName","value":"Kula"}]},{"type":"group","name":"popularity","children":[{"type":"atomic","name":"rating","value":"8"}]},{"type":"atomic","name":"city","value":"Uppsala"},{"type":"atomic","name":"country","value":"Sweden"}]} | | OK |

Try to change firstName=Rut-Emma, lastName=Projektledare, rating(popularity)=0, instructorId=123456, workoutname=cirkelfys, Validation error should be thrown, numOfParticipants missing.

!| RecordEndpointFixture |
| authToken | type | id | json | testUpdateRecord? | getStatusType? |
| $userAuthToken | testWorkout | cirkelfys1 | {"name":"workout","children":[{"name":"recordInfo","children":[{"name":"id","value":"cirkelfys1"},{"name":"type","children":[{"name":"linkedRecordType","value":"recordType"},{"name":"linkedRecordId","value":"testWorkout"}]},{"name":"createdBy","children":[{"name":"linkedRecordType","value":"user"},{"name":"linkedRecordId","value":"141414"}]},{"name":"dataDivider","children":[{"name":"linkedRecordType","value":"system"},{"name":"linkedRecordId","value":"systemOne"}]},{"name":"tsCreated","value":"2018-08-29T14:27:20.307000Z"},{"name":"updated","children":[{"name":"updatedBy","children":[{"name":"linkedRecordType","value":"user"},{"name":"linkedRecordId","value":"141414"}]},{"name":"tsUpdated","value":"2018-08-29T14:27:20.307000Z"}],"repeatId":"1"}]},{"name":"workoutName","value":"cirkelfys"},{"name":"instructorId","value":"123456"},{"name":"instructorName","children":[{"name":"firstName","value":"Rut-Emma"},{"name":"lastName","value":"Projektledare"}]},{"name":"popularity","children":[{"name":"rating","value":"0"}]}]} | Data is not valid: [Did not find enough data children with referenceId: testNumOfParticipantsTextVar(with nameInData:numOfParticipants.] | BAD_REQUEST |

Validate the '''response''' returned on the update call contains the expected record parts.

!| ChildComparerFixture |
| children | testCheckContainWithValues? |
| {"children":[{"type":"atomic","name":"workoutName","value":"cirkelfys"},{"type":"atomic","name":"instructorId","value":"6666"},{"type":"atomic","name":"numOfParticipants","value":"10"},{"type":"group","name":"instructorName","children":[{"type":"atomic","name":"firstName","value":"Emma"},{"type":"atomic","name":"lastName","value":"Kula"}]},{"type":"group","name":"popularity","children":[{"type":"atomic","name":"rating","value":"8"}]},{"type":"atomic","name":"city","value":"Uppsala"},{"type":"atomic","name":"country","value":"Sweden"}]} | OK |

Validate that nothing is changed on the stored record.

!| ChildComparerFixture |
| authToken | type | id | children | testReadAndStoreRecord? | testCheckContainWithValues? |
| $adminAuthToken | testWorkout | cirkelfys1 | {"children":[{"type":"atomic","name":"workoutName","value":"cirkelfys"},{"type":"atomic","name":"instructorId","value":"6666"},{"type":"atomic","name":"numOfParticipants","value":"10"},{"type":"group","name":"instructorName","children":[{"type":"atomic","name":"firstName","value":"Emma"},{"type":"atomic","name":"lastName","value":"Kula"}]},{"type":"group","name":"popularity","children":[{"type":"atomic","name":"rating","value":"8"}]},{"type":"atomic","name":"city","value":"Uppsala"},{"type":"atomic","name":"country","value":"Sweden"}]} | | OK |

*!
!***> Case 6

The user has read permissions on '''instructorId''' and '''numOfParticipants'''. numOfParticipants is inherit from write permission.

The user has write permissions on '''numOfParticipants'''

!| PermissionComparerFixture |
| authToken | type | id | permissions | testReadAndStoreRecord? | testCheckPermissions? |
| $userAuthToken | testWorkout | cirkelfys1 | {"read":["instructorId","numOfParticipants"]} | | OK |
| $userAuthToken | testWorkout | cirkelfys1 | {"write":["numOfParticipants"]} | | OK |

Check the permissions that should not be included on the permissions list.

!| PermissionComparerFixture |
| authToken | type | id | permissions | testReadAndStoreRecord? | testCheckPermissions? |
| $userAuthToken | testWorkout | cirkelfys1 | {"read":["recordInfo", "workOutName", "instructorName", "popularity", "city", "country"  ]} | | Read permission recordInfo is missing. Read permission workOutName is missing. Read permission instructorName is missing. Read permission popularity is missing. Read permission city is missing. Read permission country is missing. |
| $userAuthToken | testWorkout | cirkelfys1 | {"write":["recordInfo", "instructorId", "workOutName", "instructorName", "popularity", "city", "country"  ]} | | Write permission recordInfo is missing. Write permission instructorId is missing. Write permission workOutName is missing. Write permission instructorName is missing. Write permission popularity is missing. Write permission city is missing. Write permission country is missing. |

*!
