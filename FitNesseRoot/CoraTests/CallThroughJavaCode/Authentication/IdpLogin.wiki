---
Test
---
#!| script | SystemUrl |
#| setUrl | ${systemUnderTestUrl} |
#| setAppTokenVerifierUrl | ${appTokenVerifierUrl} |
#| setIdpLoginUrl | ${idpLoginUrl} |
#| setGatekeeperServerUrl | ${gatekeeperServerUrl} |
#
#!| script | DependencyProvider |
#| setHttpHandlerFactoryClassName | se.uu.ub.cora.httphandler.HttpHandlerFactoryImp |
#
!1 !-IdpLoginTest-!
!2 Fetch authTokens using idpLogin
!***> Get authTokens from idpLogin server
!| IdpLoginServletFixture |
| EPPN | getAuthTokenForEPPN? | getLoginId? | getResponseCode? | getAuthToken? | getFirstName? | getLastName? | getValidUntil? | getRenewUntil? | getTokenIdUrl? |
| fitnesseAdmin@system.cora.uu.se | |fitnesseAdmin@system.cora.uu.se | OK | $fitnesseAdminAuthToken= | | | =~/\d{13}/ | =~/\d{13}/ | $fitnesseAdminAuthTokenIdUrl= |
| fitnesseUser@system.cora.uu.se | |fitnesseUser@system.cora.uu.se | OK | $fitnesseUserAuthToken= | | |  =~/\d{13}/ | =~/\d{13}/ | $fitnesseUserAuthTokenIdUrl= |
*!
!2 Test with new texts to show that we can use our authToken and be our user
!***> Create data of recordType text (textSystemOne)

!| RecordEndpointFixture |
| authToken | type | json | testCreateRecord? | getStatusType? |
| $fitnesseUserAuthToken | text | {"name":"text","children":[{"name":"recordInfo","children":[{"name":"id","value":"myAuthText"},{"name":"validationType","children":[{"name":"linkedRecordType","value":"validationType"},{"name":"linkedRecordId","value":"textSystemOne"}]},{"children":[{"name":"linkedRecordType","value":"system"},{"name":"linkedRecordId","value":"cora"}],"name":"dataDivider"}]},{"name":"textPart","attributes":{"type":"default","lang":"sv"} ,"children":[{"name":"text","value":"Min svenska text"}]}]} | =~/"name":"linkedRecordId",\s*"value":"121212"/ | CREATED |

*!
!***> Logout

!| AppTokenEndpointFixture |
| authTokenToLogOut | deleteUrl | removeAuthTokenForUser? | getStatusType? |
| $fitnesseUserAuthToken | $fitnesseUserAuthTokenIdUrl| | OK |

*!
!2 Test with new texts to show that authToken is not valid after logout
!***> Create data of recordType text (textSystemOne)

!| RecordEndpointFixture |
| authToken | type | json | testCreateRecord? | getStatusType? |
| $fitnesseUserAuthToken | text | {"name":"text","children":[{"name":"recordInfo","children":[{"name":"id","value":"myAuthText"},{"name":"validationType","children":[{"name":"linkedRecordType","value":"validationType"},{"name":"linkedRecordId","value":"textSystemOne"}]},{"children":[{"name":"linkedRecordType","value":"system"},{"name":"linkedRecordId","value":"cora"}],"name":"dataDivider"}]},{"name":"textPart","attributes":{"type":"default","lang":"sv"} ,"children":[{"name":"text","value":"Min svenska text"}]}]} | | UNAUTHORIZED |

*!
!2 Clean up created data
!***> Clean up created data

!| RecordEndpointFixture |
| authToken | type | id | testDeleteRecord? | getStatusType? |
| $fitnesseAdminAuthToken | text | myAuthText | | OK |

!| AppTokenEndpointFixture |
| authTokenToLogOut | deleteUrl | removeAuthTokenForUser? | getStatusType? |
| $fitnesseAdminAuthToken | $fitnesseAdminAuthTokenIdUrl| | OK |

*!
